"use strict";angular.module("ml.retail",["ngRoute","ui.bootstrap","ml.common","ml.search","ml.search.tpls","google-maps"]).controller("appCtrl",["userService","$scope","$location",function(e){var n=this;n.logout=function(){console.log("logging out"),e.logout()}}]).config(["$routeProvider","$locationProvider",function(e,n){n.html5Mode(!0),n.hashPrefix("!"),e.when("/splash",{templateUrl:"/home/splash.html",controller:"splashCtrl as splashCtrl"}).when("/login",{templateUrl:"/user/login.html",controller:"loginCtrl as ctrl"}).when("/marketer/dashboard",{templateUrl:"/marketer/dashboard.html",controller:"marketerCtrl as markterCtrl"}).when("/analyst/dashboard",{templateUrl:"/analyst/dashboard.html",controller:"analystDashboardCtrl"}).when("/manager/dashboard",{templateUrl:"/manager/dashboard.html",controller:"managerDashboardCtrl"}).when("/loyalty/dashboard",{templateUrl:"/loyalty/dashboard.html",controller:"loyaltyDashboardCtrl"}).when("/consumer/home",{templateUrl:"/consumer/consumer_home.html",controller:"consumerHomeCtrl as consumerCtrl"}).when("/consumer/detail/:uri*",{templateUrl:"/consumer/product_detail.html",controller:"productDetailCtrl as productDetails",resolve:{productData:function(e,n){var r="/"+e.current.params.uri;return console.log("resolving ",r),n.getDocument(r,{format:"json",transform:"product-json"})}}}).otherwise({redirectTo:"/consumer/home"})}]).run(["$route","$location",function(e,n){console.log("route",e,n),e.reload()}]),angular.module("sample.common",[]).filter("object2Array",function(){return function(e){var n=[];for(var r in e)e[r].__key=r,n.push(e[r]);return n}}),function(){function e(e,n){return Math.abs(e-n)<1e-6}var n=function(){function n(n){var t=null,a=[],o=[],l=[],i=angular.extend({},r,n),s=this,u=null;this.center=n.center,this.zoom=i.zoom,this.dragging=!1,this.selector=i.container,this.markers=[],this.options=i,this.draw=function(){if(null!==s.center)if(null===t)console.log("creating map"),t=new google.maps.Map(s.selector,s.options),google.maps.event.addListener(t,"dragstart",function(){s.dragging=!0}),google.maps.event.addListener(t,"idle",function(){s.dragging=!1}),google.maps.event.addListener(t,"drag",function(){s.dragging=!0}),google.maps.event.addListener(t,"zoom_changed",function(){s.zoom=t.getZoom(),s.center=t.getCenter()}),google.maps.event.addListener(t,"center_changed",function(){s.center=t.getCenter()}),o.length&&angular.forEach(o,function(e){google.maps.event.addListener(t,e.on,e.handler)});else{google.maps.event.trigger(t,"resize");var n=t.getCenter();e(n.lat(),s.center.lat())&&e(n.lng(),s.center.lng())||t.setCenter(s.center),t.getZoom()!==s.zoom&&t.setZoom(s.zoom)}},this.fit=function(){if(t&&a.length){var e=new google.maps.LatLngBounds;angular.forEach(a,function(n){e.extend(n.getPosition())}),t.fitBounds(e)}},this.on=function(e,n){o.push({on:e,handler:n})},this.getMap=function(){return t},this.addMarker=function(e,n,r,o,l,i,c){function g(e){var n=new google.maps.InfoWindow({content:e});null!==u&&u.close(),n.open(t,m),u=n}if(null===s.findMarker(e,n)){var m=new google.maps.Marker({position:new google.maps.LatLng(e,n),map:t,icon:r});return null!==o&&google.maps.event.addListener(m,"click",function(){"function"==typeof o?o().then(function(e){g(e)}):g(o)}),a.unshift(m),s.markers.unshift({lat:e,lng:n,icon:r,infoWindowContent:o,label:l,url:i,thumbnail:c}),m}},this.findMarker=function(n,r){for(var t=0;t<a.length;t++){var o=a[t].getPosition();if(e(o.lat(),n)&&e(o.lng(),r))return a[t]}return null},this.findMarkerIndex=function(n,r){for(var t=0;t<a.length;t++){var o=a[t].getPosition();if(e(o.lat(),n)&&e(o.lng(),r))return t}return-1},this.addInfoWindow=function(e,n,r){var t=new google.maps.InfoWindow({content:r,position:new google.maps.LatLng(e,n)});return l.push(t),t},this.hasMarker=function(e,n){return null!==s.findMarker(e,n)},this.getMarkerInstances=function(){return a},this.removeMarkers=function(e){var n=this;angular.forEach(e,function(e){var r=e.getPosition(),t=r.lat(),o=r.lng(),l=n.findMarkerIndex(t,o);a.splice(l,1),n.markers.splice(l,1),e.setMap(null)})}}var r={zoom:8,container:null};return n}(),r=angular.module("google-maps",[]);r.directive("googleMap",["$log","$timeout","$filter",function(r,t){return{restrict:"ECA",priority:100,transclude:!0,template:'<div class="angular-google-map" ng-transclude></div>',replace:!1,scope:{options:"=options",markers:"=markers",latitude:"=latitude",longitude:"=longitude",refresh:"&refresh",windows:"=windows",events:"=events"},link:function(a,o,l){if(!angular.isDefined(a.options))return void r.error("angular-google-maps: map options property not set");var i=angular.extend(a.options,{container:o[0]}),s=new n(i);if(s.on("drag",function(){var e=s.center;t(function(){a.$apply(function(){a.options.center.latitude=e.lat(),a.options.center.longitude=e.lng()})})}),s.on("zoom_changed",function(){a.zoom!==s.zoom&&t(function(){a.$apply(function(){a.zoom=s.zoom})})}),s.on("center_changed",function(){var e=s.center;t(function(){a.$apply(function(){s.dragging||(a.options.center.latitude=e.lat(),a.options.center.longitude=e.lng())})})}),angular.isDefined(a.events)){var u=null,c=function(){a.events[u].apply(a,[s,u,arguments])};for(var g in a.events)u=g,a.events.hasOwnProperty(u)&&angular.isFunction(a.events[u])&&s.on(u,c)}if("true"===l.markClick&&!function(){var e=null;s.on("click",function(n){null===e?(e={latitude:n.latLng.lat(),longitude:n.latLng.lng()},a.markers.push(e)):(e.latitude=n.latLng.lat(),e.longitude=n.latLng.lng()),t(function(){a.latitude=e.latitude,a.longitude=e.longitude,a.$apply()})})}(),a.map=s,angular.isUndefined(a.refresh()))s.draw();else{var m=!1;a.$watch("refresh()",function(e,n){!e||m&&n||(s.draw(),m=!0)})}a.$watch("markers",function(n){console.log("watched markers"),t(function(){angular.forEach(n,function(e){s.hasMarker(e.latitude,e.longitude)||s.addMarker(e.latitude,e.longitude,e.icon,e.infoWindow)});var r=[];angular.forEach(s.getMarkerInstances(),function(n){for(var t=n.getPosition(),o=t.lat(),l=t.lng(),i=!1,s=0;s<a.markers.length;s++){var u=a.markers[s];if(e(u.latitude,o)&&e(u.longitude,l)){i=!0;break}}i||r.push(n)}),r.length&&s.removeMarkers(r),"true"===l.fit&&n&&n.length>=1&&s.fit()})},!0),a.$watch("center",function(e,n){e!==n&&(s.dragging||(s.center=new google.maps.LatLng(e.latitude,e.longitude),s.draw()))},!0),a.$watch("zoom",function(e,n){e!==n&&(s.zoom=e,s.draw())})}}}])}(),function(){function e(e,n){var r=this;r.mlSearch=e.mlSearch,r.searchService=e,r.page=r.mlSearch.getPage(),r.removeSearchTag=function(n){e.removeSearchTag(n)},n.$watch(function(){return e.isSearching},function(e){r.isSearching=e}),n.$watch(function(){return e.results},function(){r.qtext=e.qtext,r.page=r.mlSearch.getPage(),r.results=e.results}),r.search=function(){console.log("searching page %s",r.page),r.mlSearch.setPage(r.page),e.runSearch()},r.toggleFacet=function(n,t){r.mlSearch.toggleFacet(n,t),e.runSearch()}}var n=angular.module("ml.retail");n.controller("consumerHomeCtrl",e),e.$injector=["consumerSearchService","$scope"]}(),function(){function e(e){function n(){r.mlSearch.clearAdditionalQueries();for(var e=0;e<r.searchTags.length;e++){var n=r.searchTags[e];r.mlSearch.addAdditionalQuery({"container-query":{element:{name:"detail"},"and-query":{queries:[{"word-query":{element:{name:"name"},text:n.name}},{"word-query":{element:{name:"value"},text:n.value}}]}}})}}var r={};return r.mlSearch=e.newContext({pageLength:12}),r.fromParams=function(){r.mlSearch.fromParams().then(r.parseResults)},r.parseResults=function(e){r.isSearching=!1,r.qtext=r.mlSearch.getText(),r.page=r.mlSearch.getPage(),r.results=e},r.searchText=function(e){r.startSearch(),r.mlSearch.setText(e).setPage(1),r.runSearch()},r.searchPage=function(e){r.mlSearch.setPage(e),r.runSearch()},r.runSearch=function(){r.mlSearch.search().then(r.parseResults)},r.clearSearch=function(){r.mlSearch.setText("").setPage(1).clearAdditionalQueries()},r.startSearch=function(){r.isSearching=!0},r.searchTags=[],r.searchTag=function(e,t,a){a||(r.searchTags=[]),r.searchTags.push({name:e,value:t}),n(),r.runSearch()},r.removeSearchTag=function(e){r.searchTags.splice(e,1),n(),r.runSearch()},r}var n=angular.module("ml.retail");n.factory("consumerSearchService",e),e.$inject=["MLSearchFactory"]}(),function(){function e(e){return{restrict:"E",replace:!0,link:function(n){n.searchText="",n.doSearch=function(){n.searchForm.$valid?(e.searchText(n.searchText),n.searchText=""):console.log("invalid")}},templateUrl:"/consumer/consumer_subnav.html"}}var n=angular.module("ml.retail");n.directive("consumerSubnav",e),e.$injector=["consumerSearchService"]}(),function(){function e(e,n,r){var t=this;t.data=e.data,t.currentTab="description",t.showTab=function(e){t.currentTab=e},t.clickTag=function(e){n.searchTag(e.name,e.value,!0),r.path("/consumer/home")},t.isFeatureSearch=function(e){for(var r=0;r<n.searchTags.length;r++){var t=n.searchTags[r];if(t.name===e.name&&t.value===e.value)return!0}return!1},t.imageStyle={backgroundImage:"url("+t.data.largeFrontImage+")"}}var n=angular.module("ml.retail");n.controller("productDetailCtrl",e),e.$injector=["productData","consumerSearchService","$location"]}(),function(){function e(){var e=this;e.chartOptions={chart:{type:"column"},title:{text:"Stacked column chart"},xAxis:{categories:["Apples","Oranges","Pears","Grapes","Bananas"]},yAxis:{min:0,title:{text:"Total fruit consumption"}},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',shared:!0},plotOptions:{column:{stacking:"percent"}},series:[{name:"John",data:[5,3,4,7,2]},{name:"Jane",data:[2,2,3,2,1]},{name:"Joe",data:[3,4,4,2,5]}]},console.log("chart options",e.chartOptions)}function n(){return{restrict:"A",scope:{chartOptions:"=",chartData:"="},link:function(e,n){console.log("splash chart",e.chartOptions),e.chart=n.highcharts(e.chartOptions)}}}var r=angular.module("ml.retail");r.controller("splashCtrl",e).directive("splashChart",n),e.$inject=["$scope"]}(),function(){function e(){}var n=angular.module("ml.retail");n.controller("marketerCtrl",e)}(),function(){function e(e,n,r){var t=this;t.users={marketer:{label:"Marketer",desc:"Manages marketing and promotional campaigns - including social media",name:"John Marketer"},analyst:{label:"Analyst",desc:"Analyzes sales performance, site performance, etc",name:"Susie Analyst"},loyalty:{label:"Customer Loyalty Manager",desc:"Maintains customer loyalty via rewards, social campaigns, targetted cross-selling, etc",name:"Tom Loyalty"},manager:{label:"Store Manager",desc:"Manages operations of the retail store",name:"Jane Boss"}},n.$watch("ctrl.username",function(e){e?(t.userdesc=t.users[e].desc,t.userlabel=t.users[e].label):t.userdesc=t.userlabel=null}),t.login=function(){e.login(t.username,t.users[t.username].name),r.path("/"+t.username+"/dashboard").search("")}}var n=angular.module("ml.retail");n.controller("loginCtrl",e),e.$inject=["userService","$scope","$location"]}(),function(){function e(){var e={};return e.user=null,e.login=function(n,r){e.user={role:n,username:r}},e.logout=function(){e.user=null},e}var n=angular.module("ml.retail");n.service("userService",e),e.$inject=["$http","$rootScope"]}(),function(){angular.module("sample.common").factory("MLSampleQueryBuilder",[function(){var e=function(){return 1===arguments.length&&angular.isArray(arguments[0])?{"and-query":{queries:arguments[0]}}:{"and-query":{queries:Array.prototype.slice.call(arguments)}}};return{andQuery:e,boostQuery:function(n,r){return n?{"boost-query":{"matching-query":n,"boosting-query":r}}:{"boost-query":{"matching-query":e(),"boosting-query":r}}},collectionConstraintQuery:function(e,n){return{"collection-constraint-query":{"constraint-name":e,uri:Array.isArray(n)?n:[n]}}},customConstraintQuery:function(e,n){return{"custom-constraint-query":{"constraint-name":e,text:n}}},customGeospatialConstraintQuery:function(e,n,r){return{"custom-constraint-query":{"constraint-name":e,annotation:n,box:r}}},documentQuery:function(e){return{"document-query":{uri:Array.isArray(e)?e:[e]}}},geospatialConstraintQuery:function(e,n){return{"geospatial-constraint-query":{"constraint-name":e,box:n}}},operatorState:function(e,n){return{"operator-state":{"operator-name":e,"state-name":n}}},orQuery:function(){return 1===arguments.length&&angular.isArray(arguments[0])?{"or-query":{queries:arguments[0]}}:{"or-query":{queries:Array.prototype.slice.call(arguments)}}},propertiesQuery:function(e){return{"properties-query":e}},rangeConstraintQuery:function(e,n,r,t){return t||(t=[]),n||(n="EQ"),{"range-constraint-query":{"constraint-name":e,"range-operator":n,value:r,"range-option":t}}},structuredQuery:function(){return 1===arguments.length&&angular.isArray(arguments[0])?{query:{queries:arguments[0]}}:{query:{queries:Array.prototype.slice.call(arguments)}}},termQuery:function(e,n){return n?{"term-query":{text:e,weight:n}}:{"term-query":{text:e}}},textQuery:function(e){return{qtext:e}}}}])}();